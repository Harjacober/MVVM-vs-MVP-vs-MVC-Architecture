package com.example.mvvm_quizapp.repository

import android.os.Handler
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import com.example.mvvm_quizapp.model.Question
import com.example.mvvm_quizapp.model.QuestionStore
import com.example.mvvm_quizapp.model.User
import kotlin.properties.Delegates

class Repository {
    private object SingletonHelper{
        val  INSTANCE = Repository()
    }
    companion object {
        fun getInstance():Repository{
            return SingletonHelper.INSTANCE
        }
    }

    lateinit var questionStore: QuestionStore
    lateinit var user: User
    var currentQuestion = MutableLiveData<Question>()
    var currScore by Delegates.notNull<Int>()
    var numberOfQuestion = 4
    var answerQuestionLiveData = MutableLiveData<List<Any>>()
    var endGameLiveData = MutableLiveData<User>()
    var mEnableTouchEvents = MutableLiveData<Boolean>()

    fun saveUserInformation(name: String){
        user = User(name)
    }
    fun startGame(){
        questionStore = generateQuestions()
        currScore = 0
        currentQuestion.value = questionStore.getQuestion()
        mEnableTouchEvents.value = true
    }

    fun answerQuestion(answerIndex: Int){
        numberOfQuestion--
        if(answerIndex == currentQuestion.value?.answerIndex){
            currScore++
            answerQuestionLiveData.value = listOf(true,currScore)
        }else{
            answerQuestionLiveData.value = listOf(false,currScore)
        }
        displayNextQuestion()
    }
    fun getVerdict(): LiveData<List<Any>>{
        return answerQuestionLiveData
    }
    fun endGame(): LiveData<User>{
        return endGameLiveData
    }
    fun getNextQuestion(): LiveData<Question>{
        return currentQuestion
    }
    private fun resetGame(){
        questionStore = generateQuestions()
        currentQuestion = MutableLiveData()
        currScore = 0
        numberOfQuestion = 4
        answerQuestionLiveData = MutableLiveData()
        endGameLiveData = MutableLiveData()
    }

    fun displayNextQuestion(){
        mEnableTouchEvents.value = false
        Handler().postDelayed({
            // If this is the last question, ends the game.
            // Else, display the next question.
            if(numberOfQuestion==0){
                user.score = currScore
                endGameLiveData.value = user
                resetGame()
            }
            currentQuestion.value = questionStore.getQuestion()
            mEnableTouchEvents.value = true
        }, 2000)
    }
    private fun generateQuestions(): QuestionStore{
        val question1 = createQuestion(
            "What is the name of the current french president?",
            listOf(
                "François Hollande",
                "Emmanuel Macron",
                "Jacques Chirac",
                "François Mitterand"
            ),
            1
        )
        val question2 = createQuestion(
            "How many countries are there in the European Union?",
            listOf("15", "24", "28", "32"),
            2
        )
        val question3 = createQuestion(
            "Who is the creator of the Android operating system?",
            listOf("Andy Rubin", "Steve Wozniak", "Jake Wharton", "Paul Smith"),
            0
        )
        val question4 = createQuestion(
            "When did the first man land on the moon?",
            listOf("1958", "1962", "1967", "1969"),
            3
        )
        val question5 = createQuestion(
            "What is the capital of Romania?",
            listOf("Bucarest", "Warsaw", "Budapest", "Berlin"),
            0
        )
        val question6 = createQuestion(
            "Who did the Mona Lisa paint?",
            listOf("Michelangelo", "Leonardo Da Vinci", "Raphael", "Carravagio"),
            1
        )
        val question7 = createQuestion(
            "In which city is the composer Frédéric Chopin buried?",
            listOf("Strasbourg", "Warsaw", "Paris", "Moscow"),
            2
        )
        val question8 = createQuestion(
            "What is the country top-level domain of Belgium?",
            listOf(".bg", ".bm", ".bl", ".be"),
            3
        )
        val question9 = createQuestion(
            "What is the house number of The Simpsons?",
            listOf("42", "101", "666", "742"),
            3
        )
        return QuestionStore(
            listOf(
                question1,
                question2,
                question3,
                question4,
                question5,
                question6,
                question7,
                question8,
                question9
            )
        )
    }
    private fun createQuestion(question: String, options: List<String>, answerIndex:Int): Question {
        return Question(question,options,answerIndex)
    }
}